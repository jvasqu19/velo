<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title></title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        font-family: system-ui, Segoe UI, Roboto, Arial;
        max-width: 980px;
        margin: 18px auto;
        padding: 12px;
      }
      label {
        display: inline-block;
        margin: 6px 0;
      }
      .vars {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 10px;
      }
      input[type="number"] {
        width: 160px;
      }
      table {
        border-collapse: collapse;
        margin-top: 10px;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #999;
        padding: 6px 8px;
        text-align: right;
      }
      .note {
        background: #fffae6;
        border-left: 4px solid #f7d070;
        padding: 8px;
        margin: 8px 0;
      }
      .error {
        background: #ffecec;
        border-left: 4px solid #f44336;
        padding: 8px;
        margin: 8px 0;
      }
      pre {
        background: #f6f8fa;
        padding: 8px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h2>Calculadora de payback</h2>
    <p>Seleccionar variables <strong>fijas</strong></p>

    <form id="form">
      <div class="vars">
        <div>
          <label>
            <input type="checkbox" class="fix" value="initial_users" checked />
            Initial users </label
          ><br />
          <input id="initial_users" type="number" step="any" value="200" />
        </div>

        <div>
          <label>
            <input type="checkbox" class="fix" value="rentxsqmt" />
            Rent per sqm </label
          ><br />
          <input
            id="rentxsqmt"
            type="number"
            step="any"
            placeholder="e.g. 30000"
          />
        </div>

        <div>
          <label>
            <input type="checkbox" class="fix" value="sqmt" />
            Metros cuadrados </label
          ><br />
          <input id="sqmt" type="number" step="any" placeholder="e.g. 800" />
        </div>

        <div>
          <label>
            <input type="checkbox" class="fix" value="usersxsqmt" />
            Users per sqm </label
          ><br />
          <input
            id="usersxsqmt"
            type="number"
            step="any"
            placeholder="e.g. 0.5"
          />
        </div>

        <div>
          <label>
            <input type="checkbox" class="fix" value="utilities" />
            Servicios públicos por mt2 </label
          ><br />
          <input
            id="utilities"
            type="number"
            step="any"
            placeholder="e.g. 14000"
          />
        </div>

        <div>
          <label>
            <input type="checkbox" class="fix" value="obra" />
            Obra per sqmt </label
          ><br />
          <input id="obra" type="number" step="any" placeholder="e.g. 500000" />
        </div>

        <div>
          <label>
            <input type="checkbox" class="fix" value="equipos" />
            Equipos per mt2 </label
          ><br />
          <input
            id="equipos"
            type="number"
            step="any"
            placeholder="e.g. 600000"
          />
        </div>
      </div>

      <label>
        Payback en meses:
        <input id="target" type="number" step="any" value="24" />
      </label>
      &nbsp;&nbsp;
      <label>
        Intentos:
        <input id="maxTries" type="number" value="40000" min="1000" />
      </label>

      <br /><br />
      <button type="submit">Calcular combinaciones</button>
    </form>

    <div id="status"></div>
    <div id="result"></div>

    <script>
      /* Modelo y^ payback, X {equipos, obra, initial_users, rentxsqmt, sqmt, userxsqmt, utilities} */
      const betas = {
        intercept: -143.61225,
        equipos: 0.0,
        obra: 10.29005,
        initial_users: -11.82543,
        rentxsqmt: 4.63316,
        sqmt: 6.1259,
        usersxsqmt: -9.08976,
        utilities: 0.05709,
      };

      const ranges = {
        initial_users: { min: 1, max: 999 },
        rentxsqmt: { min: 25001, max: 80000 },
        sqmt: { min: 300, max: 999 },
        usersxsqmt: { min: 0.1, max: 2.09 },
        utilities: { min: 13001, max: 16999 },
        obra: { min: 100000, max: 2000000 },
        equipos: { min: 100000, max: 1400000 },
      };

      const CAPEX_THRESHOLD = 1200000000; 

      /* helpers */
      function randRange(min, max) {
        return Math.random() * (max - min) + min;
      }

      function pretty(n) {
        return typeof n === "number"
          ? Number(n).toLocaleString(undefined, { maximumFractionDigits: 4 })
          : n;
      }

      /* todos los valores positivos y non empty */
      function regressionY(vars) {
        let y = betas.intercept;
        for (const k in betas) {
          if (k === "intercept") continue;
          if (!(vars[k] > 0)) return NaN;
          y += betas[k] * Math.log(vars[k]);
        }
        return y;
      }

      /* reestricciones */
      function checkAll(v) {
        for (const k in ranges) {
          if (!(typeof v[k] === "number" && isFinite(v[k]) && v[k] > 0)) {
            return { ok: false, reason: `${k} is missing or not positive` };
          }
          if (v[k] < ranges[k].min - 1e-9 || v[k] > ranges[k].max + 1e-9) {
            return {
              ok: false,
              reason: `${k}=${pretty(v[k])} outside allowed range [${
                ranges[k].min
              }, ${ranges[k].max}]`,
            };
          }
        }

        if (!(v.initial_users < 1000))
          return { ok: false, reason: "initial_users >= 1000" };
        if (!(v.rentxsqmt > 25000))
          return { ok: false, reason: "rentxsqmt <= 25000" };
        if (!(v.usersxsqmt < 2.1))
          return { ok: false, reason: "usersxsqmt >= 2.1" };
        if (!(v.utilities > 13000 && v.utilities < 17000))
          return { ok: false, reason: "utilities not in (13000,17000)" };
        if (!(v.sqmt < 1000)) return { ok: false, reason: "sqmt >= 1000" };

        const capex = (v.equipos + v.obra) * v.sqmt;
        if (!(capex > CAPEX_THRESHOLD)) {
          return {
            ok: false,
            reason: `CAPEX no cuadra: (equipos+obra)*sqmt = ${pretty(
              capex
            )} <= ${pretty(CAPEX_THRESHOLD)}`,
          };
        }

        const ratio = v.equipos / (v.equipos + v.obra);
        if (!(ratio >= 0.15 && ratio <= 0.4)) {
          return {
            ok: false,
            reason: `equipos/(equipos+obra) ratio ${pretty(
              ratio
            )} not in [0.2, 0.4]`,
          };
        }

        if (v.equipos > 800000) {
          return {
            ok: false,
            reason: `equipos = ${pretty(v.equipos)} exceeds 800000`,
          };
        }

        return { ok: true };
      }

      /* ChatGPT organizar script */
      function getFixed() {
        const names = Object.keys(ranges);
        let fixed = {};
        document.querySelectorAll(".fix").forEach((cb) => {
          if (cb.checked) {
            const name = cb.value;
            const el = document.getElementById(name);
            const val = Number(el.value);
            if (isFinite(val) && val > 0) fixed[name] = val;
          }
        });
        return fixed;
      }

      /* main */
      document.getElementById("form").addEventListener("submit", function (e) {
        e.preventDefault();

        const statusEl = document.getElementById("status");
        const resultEl = document.getElementById("result");
        statusEl.innerHTML = "";
        resultEl.innerHTML = "";

        const target = Number(document.getElementById("target").value);
        const maxTries = Math.max(
          1000,
          Number(document.getElementById("maxTries").value) || 40000
        );
        const fixed = getFixed();

        const allVars = Object.keys(ranges);
        const freeVars = allVars.filter((v) => !(v in fixed));

        // validate fixed values vs ranges
        for (const k in fixed) {
          if (!(fixed[k] >= ranges[k].min && fixed[k] <= ranges[k].max)) {
            resultEl.innerHTML = `<div class="error">Fixed variable <strong>${k}</strong> = ${pretty(
              fixed[k]
            )} is outside allowed range [${ranges[k].min}, ${
              ranges[k].max
            }].</div>`;
            return;
          }
        }

        let solutions = [];

        // algebraic solve if one free variable ChatGPT
        if (freeVars.length === 1 && Math.abs(betas[freeVars[0]]) > 1e-12) {
          const varName = freeVars[0];

          let sumOthers = betas.intercept;
          for (const k of allVars) {
            if (k === varName) continue;
            const x = fixed[k];
            if (!(typeof x === "number" && x > 0)) {
              resultEl.innerHTML = `<div class="note">Can't algebraically solve because variable <strong>${k}</strong> is missing or non-positive.</div>`;
              return;
            }
            sumOthers += betas[k] * Math.log(x);
          }

          const beta_j = betas[varName];
          const ln_x = (target - sumOthers) / beta_j;
          const solved = Math.exp(ln_x);

          statusEl.innerHTML = `<div class="note"><strong>Solución ${varName}:</strong> ${pretty(
            solved
          )} </div>`;

          let candidate = Object.assign({}, fixed);
          candidate[varName] = solved;

          const chk = checkAll(candidate);
          if (chk.ok) {
            const y = regressionY(candidate);
            solutions.push({ vars: candidate, y });
          } else {
            resultEl.innerHTML = `<div class="error">Solución no válida ${
              chk.reason
            }</div>
             <div style="margin-top:8px"><strong>Details</strong>
             <pre>${JSON.stringify(
               { solvedVar: varName, solvedValue: solved, reason: chk.reason },
               null,
               2
             )}</pre></div>`;
            return;
          }
        }

        // random search
        if (solutions.length === 0) {
          statusEl.innerHTML = `<div class="note">Combinaciones calculando (hasta ${maxTries} tries)...</div>`;

          let tries = 0;
          let rejectionReasons = {};
          const tolerance = 0.25;

          while (solutions.length < 10 && tries < maxTries) {
            tries++;
            let cand = Object.assign({}, fixed);

            const oneEquipGiven = "equipos" in fixed && !("obra" in fixed);
            const oneObraGiven = "obra" in fixed && !("equipos" in fixed);

            for (const v of allVars) {
              if (v in cand) continue;
              if (oneEquipGiven && v === "obra") {
                // Ensure ratio stays within 20-40% range
                const minObra = fixed.equipos * 1.5; // For 40% ratio
                const maxObra = fixed.equipos * 4; // For 20% ratio
                cand.obra = randRange(
                  Math.max(minObra, ranges.obra.min),
                  Math.min(maxObra, ranges.obra.max)
                );
                continue;
              }
              if (oneObraGiven && v === "equipos") {
                // Ensure ratio stays within 20-40% range
                const minEquipos = fixed.obra * 0.2; // For 20% ratio
                const maxEquipos = Math.min(fixed.obra * 0.4, 800000); // For 40% ratio, capped at 800k
                cand.equipos = randRange(
                  Math.max(minEquipos, ranges.equipos.min),
                  Math.min(maxEquipos, ranges.equipos.max)
                );
                continue;
              }
              cand[v] = randRange(ranges[v].min, ranges[v].max);
            }

            const chk = checkAll(cand);
            if (!chk.ok) {
              rejectionReasons[chk.reason] =
                (rejectionReasons[chk.reason] || 0) + 1;
              continue;
            }

            const y = regressionY(cand);
            if (!isFinite(y)) continue;

            if (Math.abs(y - target) <= tolerance) {
              solutions.push({ vars: cand, y });
            }
          }

          statusEl.innerHTML += `<div>${solutions.length} Combinaciones found after ${tries} attempts.</div>`;

          // Show top rejection reasons if no solutions found
          if (
            solutions.length === 0 &&
            Object.keys(rejectionReasons).length > 0
          ) {
            let topReasons = Object.entries(rejectionReasons)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 5)
              .map(([reason, count]) => `<li>${reason} (${count} times)</li>`)
              .join("");
            statusEl.innerHTML += `<div class="note"><strong>Top constraint violations:</strong><ul>${topReasons}</ul></div>`;
          }
        }

        if (solutions.length === 0) {
          resultEl.innerHTML = `<div class="error">No feasible combinations found.</div>
           <div style="margin-top:8px"><strong>Possible causes and checks</strong>
           <ul>
             <li>Algebraic solution may be outside sqm range [${
               ranges.sqmt.min
             },${ranges.sqmt.max}].</li>
             <li>CAPEX constraint: (equipos+obra)*sqmt must exceed ${pretty(
               CAPEX_THRESHOLD
             )}.</li>
             <li>equipos/(equipos+obra) ratio must be between 20% and 40%.</li>
             <li>equipos must not exceed 800000.</li>
             <li>One or more fixed values violate domain/range limits.</li>
             <li>If too many variables are fixed, the required free variable may become unrealistic.</li>
           </ul></div>`;
          return;
        }

                let html =
          "<h3>Combinaciones</h3><table><thead><tr>" +
          "<th>Equipos per m²</th><th>Obra per m²</th><th>Equipos+Obra</th><th>CAPEX</th>" +
          "<th>Initial users</th><th>Rent/sqm</th>" +
          "<th>Sqm</th><th>Users/sqm</th><th>Utilities per m²</th><th>Payback</th>" +
          "</tr></thead><tbody>";

        for (const sol of solutions) {
          const s = sol.vars;
          const equiposObra = s.equipos + s.obra;
          const capex = equiposObra * s.sqmt;

          html += `<tr>
            <td>${pretty(s.equipos)}</td>
            <td>${pretty(s.obra)}</td>
            <td>${pretty(equiposObra)}</td>
            <td>$${capex.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
            <td>${pretty(s.initial_users)}</td>
            <td>${pretty(s.rentxsqmt)}</td>
            <td>${pretty(s.sqmt)}</td>
            <td>${pretty(s.usersxsqmt)}</td>
            <td>${pretty(s.utilities)}</td>
            <td>${Number(sol.y).toFixed(6)}</td>
          </tr>`;
        }
        html += "</tbody></table>";


        resultEl.innerHTML = html;
      });
    </script>
  </body>
</html>
