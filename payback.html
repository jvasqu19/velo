<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora de Payback</title>
  <meta name="description" content="PAYBACK ACTION">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: hsl(0 0% 0%);
      color: hsl(0 0% 95%);
      min-height: 100vh;
      padding: 24px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: linear-gradient(135deg, hsl(0 0% 5%), hsl(0 0% 15%));
      padding: 48px 32px;
      border-radius: 12px;
      margin-bottom: 32px;
      box-shadow: 0 4px 24px -4px hsl(0 0% 100% / 0.15);
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, hsl(0 0% 85%), hsl(0 0% 70%));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 1.125rem;
      color: hsl(0 0% 60%);
    }

    .card {
      background: linear-gradient(135deg, hsl(0 0% 8%), hsl(0 0% 12%));
      border: 1px solid hsl(0 0% 22%);
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px -2px hsl(0 0% 0% / 0.5);
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 24px;
      color: hsl(0 0% 90%);
    }

    .vars-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .var-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      color: hsl(0 0% 95%);
      cursor: pointer;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: hsl(0 0% 90%);
    }

    input[type="number"] {
      width: 100%;
      padding: 10px 14px;
      background: hsl(0 0% 8%);
      border: 1px solid hsl(0 0% 22%);
      border-radius: 6px;
      color: hsl(0 0% 95%);
      font-size: 0.875rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

     input[type="number"]:disabled {
      background: hsl(0, 0%, 58%);
      border-color: hsl(0, 100%, 50%);
      color: hsl(0 0% 65%);
      opacity: 0.8;
      cursor: not-allowed;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: hsl(0 0% 90%);
      box-shadow: 0 0 0 2px hsl(0 0% 90% / 0.2);
    }

    input[type="number"]::placeholder {
      color: hsl(0 0% 45%);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
      margin-bottom: 24px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: hsl(0 0% 95%);
    }

    button {
      padding: 12px 32px;
      background: linear-gradient(135deg, hsl(0 0% 85%), hsl(0 0% 70%));
      color: hsl(0 0% 10%);
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px -2px hsl(0 0% 100% / 0.25);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px -2px hsl(0 0% 100% / 0.35);
    }

    button:active {
      transform: translateY(0);
    }

    .status {
      padding: 16px;
      background: hsl(0 0% 12%);
      border: 1px solid hsl(0 0% 25%);
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.875rem;
      color: hsl(0 0% 80%);
    }

    .error {
      background: hsl(0 84% 60% / 0.15);
      border: 1px solid hsl(0 84% 60%);
      color: hsl(0 84% 80%);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .success {
      background: hsl(142 76% 36% / 0.15);
      border: 1px solid hsl(142 76% 45%);
      color: hsl(142 76% 70%);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 0.875rem;
    }

    th {
      background: hsl(0 0% 15%);
      color: hsl(0 0% 90%);
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      border: 1px solid hsl(0 0% 25%);
    }

    td {
      padding: 12px 16px;
      border: 1px solid hsl(0 0% 20%);
      color: hsl(0 0% 85%);
    }

    tr:nth-child(even) {
      background: hsl(0 0% 10%);
    }

    tr:hover {
      background: hsl(0 0% 14%);
    }

    pre {
      background: hsl(0 0% 8%);
      padding: 16px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 0.75rem;
      color: hsl(0 0% 75%);
      margin-top: 12px;
    }

    ul {
      margin-left: 20px;
      margin-top: 8px;
    }

    li {
      margin-bottom: 4px;
      color: hsl(0 0% 75%);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Calculadora de Payback</h1>
      <p class="subtitle">Reverse payback</p>
    </div>

    <form id="form">
      <div class="card">
        <h2 class="card-title">Variables del Modelo</h2>
        <p style="margin-bottom: 24px; color: hsl(0 0% 60%);">Seleccione las variables fijas y configure sus valores</p>
        
        <div class="vars-grid">
          <div class="var-item">
            <label class="checkbox-label">
              <input type="checkbox" class="fix" value="initial_users" checked />
              <span>Initial Users</span>
            </label>
            <input id="initial_users" type="number" step="any" value="200" />
          </div>

          <div class="var-item">
            <label class="checkbox-label">
              <input type="checkbox" class="fix" value="rentxsqmt" />
              <span>Rent per sqm</span>
            </label>
            <input id="rentxsqmt" type="number" step="any" placeholder="e.g. 30000" />
          </div>

          <div class="var-item">
            <label class="checkbox-label">
              <input type="checkbox" class="fix" value="sqmt" />
              <span>Metros Cuadrados</span>
            </label>
            <input id="sqmt" type="number" step="any" placeholder="e.g. 800" />
          </div>

          <div class="var-item">
            <label class="checkbox-label">
              <input type="checkbox" class="fix" value="usersxsqmt" />
              <span>Users per sqm</span>
            </label>
            <input id="usersxsqmt" type="number" step="any" placeholder="e.g. 0.5" />
          </div>

          <div class="var-item">
            <label class="checkbox-label">
              <input type="checkbox" class="fix" value="utilities" />
              <span>Servicios Públicos por m²</span>
            </label>
            <input id="utilities" type="number" step="any" placeholder="e.g. 14000" />
          </div>

          <div class="var-item">
            <label class="checkbox-label">
              <input type="checkbox" class="fix" value="obra" />
              <span>Obra per sqm</span>
            </label>
            <input id="obra" type="number" step="any" placeholder="e.g. 500000" />
          </div>

          <div class="var-item">
            <label class="checkbox-label">
              <input type="checkbox" class="fix" value="equipos" />
              <span>Equipos per m²</span>
            </label>
            <input id="equipos" type="number" step="any" placeholder="e.g. 600000" />
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">Parámetros de Cálculo</h2>
        <div class="controls">
          <div class="control-group">
            <label class="control-label" for="target">Payback Objetivo (meses)</label>
            <input id="target" type="number" step="any" value="24" style="width: 180px;" />
          </div>

          <div class="control-group">
            <label class="control-label" for="maxTries">Intentos Máximos</label>
            <input id="maxTries" type="number" value="40000" min="1000" style="width: 180px;" />
          </div>

          <button type="submit">Calcular Combinaciones</button>
        </div>
      </div>
    </form>

    <div id="status"></div>
    <div id="result"></div>
  </div>

  <script>
    const betas = {
      intercept: -143.61225,
      equipos: 0.0,
      obra: 10.29005,
      initial_users: -11.82543,
      rentxsqmt: 4.63316,
      sqmt: 6.1259,
      usersxsqmt: -9.08976,
      utilities: 0.05709,
    };

    const ranges = {
      initial_users: { min: 1, max: 999 },
      rentxsqmt: { min: 25001, max: 80000 },
      sqmt: { min: 300, max: 999 },
      usersxsqmt: { min: 0.1, max: 2.09 },
      utilities: { min: 13001, max: 16999 },
      obra: { min: 600000, max: 2000000 },
      equipos: { min: 600000, max: 1400000 },
    };

    const CAPEX_THRESHOLD = 1200000000;

    function randRange(min, max) {
      return Math.random() * (max - min) + min;
    }

    function pretty(n) {
      return typeof n === "number"
        ? Number(n).toLocaleString(undefined, { maximumFractionDigits: 4 })
        : n;
    }

    function regressionY(vars) {
      let y = betas.intercept;
      for (const k in betas) {
        if (k === "intercept") continue;
        if (!(vars[k] > 0)) return NaN;
        y += betas[k] * Math.log(vars[k]);
      }
      return y;
    }

    function checkAll(v) {
      for (const k in ranges) {
        if (!(typeof v[k] === "number" && isFinite(v[k]) && v[k] > 0)) {
          return { ok: false, reason: `${k} is missing or not positive` };
        }
        if (v[k] < ranges[k].min - 1e-9 || v[k] > ranges[k].max + 1e-9) {
          return {
            ok: false,
            reason: `${k}=${pretty(v[k])} outside allowed range [${ranges[k].min}, ${ranges[k].max}]`,
          };
        }
      }

      if (!(v.initial_users < 1000))
        return { ok: false, reason: "initial_users >= 1000" };
      if (!(v.rentxsqmt > 25000))
        return { ok: false, reason: "rentxsqmt <= 25000" };
      if (!(v.usersxsqmt < 2.1))
        return { ok: false, reason: "usersxsqmt >= 2.1" };
      if (!(v.utilities > 13000 && v.utilities < 17000))
        return { ok: false, reason: "utilities not in (13000,17000)" };
      if (!(v.sqmt < 1000)) return { ok: false, reason: "sqmt >= 1000" };

      const capex = (v.equipos + v.obra) * v.sqmt;
      if (!(capex > CAPEX_THRESHOLD)) {
        return {
          ok: false,
          reason: `CAPEX no cuadra: (equipos+obra)*sqmt = ${pretty(capex)} <= ${pretty(CAPEX_THRESHOLD)}`,
        };
      }

      const ratio = v.equipos / (v.equipos + v.obra);
      if (!(ratio >= 0.15 && ratio <= 0.4)) {
        return {
          ok: false,
          reason: `equipos/(equipos+obra) ratio ${pretty(ratio)} not in [0.15, 0.4]`,
        };
      }

      if (v.equipos > 800000) {
        return {
          ok: false,
          reason: `equipos = ${pretty(v.equipos)} exceeds 800000`,
        };
      }

      return { ok: true };
    }

    function getFixed() {
      const names = Object.keys(ranges);
      let fixed = {};
      document.querySelectorAll(".fix").forEach((cb) => {
        if (cb.checked) {
          const name = cb.value;
          const el = document.getElementById(name);
          const val = Number(el.value);
          if (isFinite(val) && val > 0) fixed[name] = val;
        }
      });
      return fixed;
    }

    document.getElementById("form").addEventListener("submit", function (e) {
      e.preventDefault();

      const statusEl = document.getElementById("status");
      const resultEl = document.getElementById("result");
      statusEl.innerHTML = "";
      resultEl.innerHTML = "";

      const target = Number(document.getElementById("target").value);
      const maxTries = Math.max(1000, Number(document.getElementById("maxTries").value) || 40000);
      const fixed = getFixed();

      const allVars = Object.keys(ranges);
      const freeVars = allVars.filter((v) => !(v in fixed));

      for (const k in fixed) {
        if (!(fixed[k] >= ranges[k].min && fixed[k] <= ranges[k].max)) {
          resultEl.innerHTML = `<div class="error">Fixed variable <strong>${k}</strong> = ${pretty(fixed[k])} is outside allowed range [${ranges[k].min}, ${ranges[k].max}].</div>`;
          return;
        }
      }

      let solutions = [];

      if (freeVars.length === 1 && Math.abs(betas[freeVars[0]]) > 1e-12) {
        const varName = freeVars[0];

        let sumOthers = betas.intercept;
        for (const k of allVars) {
          if (k === varName) continue;
          const x = fixed[k];
          if (!(typeof x === "number" && x > 0)) {
            resultEl.innerHTML = `<div class="status">Can't algebraically solve because variable <strong>${k}</strong> is missing or non-positive.</div>`;
            return;
          }
          sumOthers += betas[k] * Math.log(x);
        }

        const beta_j = betas[varName];
        const ln_x = (target - sumOthers) / beta_j;
        const solved = Math.exp(ln_x);

        statusEl.innerHTML = `<div class="success"><strong>Solución algebraica ${varName}:</strong> ${pretty(solved)}</div>`;

        let candidate = Object.assign({}, fixed);
        candidate[varName] = solved;

        const chk = checkAll(candidate);
        if (chk.ok) {
          const y = regressionY(candidate);
          solutions.push({ vars: candidate, y });
        } else {
          resultEl.innerHTML = `<div class="error">Solución no válida: ${chk.reason}</div>
           <div style="margin-top:12px"><strong>Detalles:</strong>
           <pre>${JSON.stringify({ solvedVar: varName, solvedValue: solved, reason: chk.reason }, null, 2)}</pre></div>`;
          return;
        }
      }

      if (solutions.length === 0) {
        statusEl.innerHTML = `<div class="status">Calculando combinaciones (hasta ${maxTries} intentos)...</div>`;

        let tries = 0;
        let rejectionReasons = {};
        const tolerance = 0.25;

        while (solutions.length < 10 && tries < maxTries) {
          tries++;
          let cand = Object.assign({}, fixed);

          const oneEquipGiven = "equipos" in fixed && !("obra" in fixed);
          const oneObraGiven = "obra" in fixed && !("equipos" in fixed);

          for (const v of allVars) {
            if (v in cand) continue;
            if (oneEquipGiven && v === "obra") {
              const minObra = fixed.equipos * 1.5;
              const maxObra = fixed.equipos * 4;
              cand.obra = randRange(
                Math.max(minObra, ranges.obra.min),
                Math.min(maxObra, ranges.obra.max)
              );
              continue;
            }
            if (oneObraGiven && v === "equipos") {
              const minEquipos = fixed.obra * 0.2;
              const maxEquipos = Math.min(fixed.obra * 0.4, 800000);
              cand.equipos = randRange(
                Math.max(minEquipos, ranges.equipos.min),
                Math.min(maxEquipos, ranges.equipos.max)
              );
              continue;
            }
            cand[v] = randRange(ranges[v].min, ranges[v].max);
          }

          const chk = checkAll(cand);
          if (!chk.ok) {
            rejectionReasons[chk.reason] = (rejectionReasons[chk.reason] || 0) + 1;
            continue;
          }

          const y = regressionY(cand);
          if (!isFinite(y)) continue;

          if (Math.abs(y - target) <= tolerance) {
            solutions.push({ vars: cand, y });
          }
        }

        statusEl.innerHTML += `<div class="success">${solutions.length} combinaciones encontradas después de ${tries} intentos.</div>`;

        if (solutions.length === 0 && Object.keys(rejectionReasons).length > 0) {
          let topReasons = Object.entries(rejectionReasons)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([reason, count]) => `<li>${reason} (${count} veces)</li>`)
            .join("");
          statusEl.innerHTML += `<div class="status"><strong>Principales violaciones de restricciones:</strong><ul>${topReasons}</ul></div>`;
        }
      }

      if (solutions.length === 0) {
        resultEl.innerHTML = `<div class="error"><strong>No se encontraron combinaciones factibles.</strong></div>
         <div class="status"><strong>Posibles causas:</strong>
         <ul>
           <li>La solución algebraica puede estar fuera del rango de sqm [${ranges.sqmt.min},${ranges.sqmt.max}].</li>
           <li>Restricción CAPEX: (equipos+obra)*sqmt debe exceder ${pretty(CAPEX_THRESHOLD)}.</li>
           <li>La relación equipos/(equipos+obra) debe estar entre 15% y 40%.</li>
           <li>Equipos no debe exceder 800000.</li>
           <li>Uno o más valores fijos violan los límites de dominio/rango.</li>
           <li>Si demasiadas variables están fijas, la variable libre requerida puede volverse poco realista.</li>
         </ul></div>`;
        return;
      }

      let html = '<div class="card"><h2 class="card-title">Resultados: Combinaciones Factibles</h2><table><thead><tr>' +
        "<th>Equipos/m²</th><th>Obra/m²</th><th>Equipos+Obra</th><th>CAPEX</th>" +
        "<th>Initial Users</th><th>Rent/sqm</th>" +
        "<th>Sqm</th><th>Users/sqm</th><th>Utilities/m²</th><th>Payback</th>" +
        "</tr></thead><tbody>";

      for (const sol of solutions) {
        const s = sol.vars;
        const equiposObra = s.equipos + s.obra;
        const capex = equiposObra * s.sqmt;

        html += `<tr>
          <td>${pretty(s.equipos)}</td>
          <td>${pretty(s.obra)}</td>
          <td>${pretty(equiposObra)}</td>
          <td>$${capex.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
          <td>${pretty(s.initial_users)}</td>
          <td>${pretty(s.rentxsqmt)}</td>
          <td>${pretty(s.sqmt)}</td>
          <td>${pretty(s.usersxsqmt)}</td>
          <td>${pretty(s.utilities)}</td>
          <td>${Number(sol.y).toFixed(6)}</td>
        </tr>`;
      }
      html += "</tbody></table></div>";

      resultEl.innerHTML = html;
    });

        document.querySelectorAll(".fix").forEach(cb => {
      const input = document.getElementById(cb.value);
      if (input) {
        input.disabled = !cb.checked; // initial state
        cb.addEventListener("change", () => {
          input.disabled = !cb.checked;
        });
      }
    });
  </script>
</body>
</html>
